#!/bin/sh

set -e

# Source agent variables from file created by Installer
if [ ! -z "$PLATFORM_MANAGEABILITY_URL" ]; then
    sed -i "s/^  serviceURL: '.*'/  serviceURL: '$PLATFORM_MANAGEABILITY_URL'/" /etc/edge-node/node/confs/platform-manageability-agent.yaml
fi

if [ ! -z "$RPS_ADDRESS" ]; then
    sed -i "s/^rpsAddress: '.*'/rpsAddress: '$RPS_ADDRESS'/" /etc/edge-node/node/confs/platform-manageability-agent.yaml
fi

if [ ! -z "$NODE_METRICS_ENABLED" ]; then
    sed -i -e '/^metrics:$/{n' -e 's/enabled:.*/enabled: '"$NODE_METRICS_ENABLED"'/' -e '}' /etc/edge-node/node/confs/platform-manageability-agent.yaml
fi

# Create system group if it doesn't exist
groupadd -f bm-agents --system

# Create system user if it doesn't exist
id -u pm-agent >/dev/null 2>&1 || useradd pm-agent --system -g bm-agents -s /sbin/nologin

GUID="$(cat /sys/class/dmi/id/product_uuid)"
sed -i "s/^GUID: '.*'/GUID: '$GUID'/" /etc/edge-node/node/confs/platform-manageability-agent.yaml

#DEBHELPER#
