#!/bin/bash
set -e

if ! id "inbc" &>/dev/null; then
    if getent group inbc > /dev/null; then
        useradd --system --no-create-home --shell /usr/sbin/nologin -g inbc inbc
    else
        useradd --system --no-create-home --shell /usr/sbin/nologin inbc
    fi
fi

# Create the directories and set permissions
mkdir -p /var/intel-manageability
chown root:root /var/intel-manageability
chmod 755 /var/intel-manageability

mkdir -p /var/cache/manageability/repository-tool/sota
chmod 755 /var/cache/manageability/repository-tool/sota
mkdir -p /var/cache/manageability/repository-tool/sota/metadata

# Load AppArmor profile if AppArmor is available and on Ubuntu
if [ -r /etc/os-release ]; then
    . /etc/os-release
    if [ "$ID" = "ubuntu" ]; then
        APPARMOR_PROFILE="/etc/apparmor.d/usr.bin.inbd"
        if command -v apparmor_parser >/dev/null 2>&1 && [ -f "$APPARMOR_PROFILE" ]; then
            echo "Loading AppArmor profile for inbd..."
            if ! apparmor_parser -r -W -T "$APPARMOR_PROFILE"; then
                echo "Error: Failed to load AppArmor profile $APPARMOR_PROFILE" >&2
                exit 1
            fi
        fi
    fi
else
    echo "Warning: /etc/os-release not found or not readable. Skipping AppArmor profile loading." >&2
fi

exit 0
