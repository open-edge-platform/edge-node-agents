abi <abi/3.0>,

include <tunables/global>

/opt/health-check/bin/fluent-bit {
  include <abstractions/base>
  include <abstractions/dbus-session-strict>
  include <abstractions/nameservice>
  include <abstractions/openssl>

  capability net_admin,
  capability sys_resource,
  capability setgid,
  capability setuid,
  capability audit_write,
  capability sys_ptrace,
  capability sys_admin,
  capability dac_read_search,
  capability dac_override,

  dbus (send) bus=system interface=org.freedesktop.DBus.Properties member=GetAll path=/org/freedesktop/hostname1,
  dbus (send) bus=system interface=org.freedesktop.DBus.Properties member=GetAll path=/org/freedesktop/systemd1,
  dbus (send) bus=system interface=org.freedesktop.DBus.Properties member=Get path=/org/freedesktop/systemd1/unit/caddy_2eservice,
  dbus (send) bus=system interface=org.freedesktop.DBus.Properties member=Get path=/org/freedesktop/systemd1/unit/install_2dprofile_2dpkgs_2dand_2dnode_2dagent_2eservice,
  dbus (send) bus=system interface=org.freedesktop.DBus.Properties member=Get path=/org/freedesktop/systemd1/unit/lpke_2eservice,
  dbus (send) bus=system interface=org.freedesktop.DBus.Properties member=Get path=/org/freedesktop/systemd1/unit/hardware_2ddiscovery_2dagent_2eservice,
  dbus (send) bus=system interface=org.freedesktop.DBus.Properties member=Get path=/org/freedesktop/systemd1/unit/cluster_2dagent_2eservice,
  dbus (send) bus=system interface=org.freedesktop.DBus.Properties member=Get path=/org/freedesktop/systemd1/unit/node_2dagent_2eservice,
  dbus (send) bus=system interface=org.freedesktop.DBus.Properties member=Get path=/org/freedesktop/systemd1/unit/vault_2dagent_2eservice,
  dbus (send) bus=system interface=org.freedesktop.DBus.Properties member=Get path=/org/freedesktop/systemd1/unit/platform_2dupdate_2dagent_2eservice,
  dbus (send) bus=system interface=org.freedesktop.DBus.Properties member=Get path=/org/freedesktop/systemd1/unit/platform_2dtelemetry_2dagent_2eservice,
  dbus (send) bus=system interface=org.freedesktop.DBus.Properties member=Get path=/org/freedesktop/systemd1/unit/platform_2dobservability_2dlogging_2eservice,
  dbus (send) bus=system interface=org.freedesktop.DBus.Properties member=Get path=/org/freedesktop/systemd1/unit/platform_2dobservability_2dmetrics_2eservice,
  dbus (send) bus=system interface=org.freedesktop.DBus.Properties member=Get path=/org/freedesktop/systemd1/unit/platform_2dobservability_2dcollector_2eservice,
  dbus (send) bus=system interface=org.freedesktop.DBus.Properties member=Get path=/org/freedesktop/systemd1/unit/platform_2dmanageability_2dagent_2eservice,
  dbus (send) bus=system interface=org.freedesktop.DBus.Properties member=Get path=/org/freedesktop/systemd1/unit/inbm_2eservice,
  dbus (send) bus=system interface=org.freedesktop.DBus.Properties member=Get path=/org/freedesktop/systemd1/unit/inbm_2ddispatcher_2eservice,
  dbus (send) bus=system interface=org.freedesktop.DBus.Properties member=Get path=/org/freedesktop/systemd1/unit/inbm_2dconfiguration_2eservice,
  dbus (send) bus=system interface=org.freedesktop.DBus.Properties member=Get path=/org/freedesktop/systemd1/unit/inbm_2ddiagnostic_2eservice,
  dbus (send) bus=system interface=org.freedesktop.DBus.Properties member=Get path=/org/freedesktop/systemd1/unit/inbm_2dtelemetry_2eservice,

  ptrace (read),

  /etc/edge-node/node/confs/platform-observability-health-check ix,
  /etc/health-check/health-check.conf r,
  /etc/locale.conf r,
  /opt/health-check/bin/fluent-bit mr,
  /dev/tty rmw,
  /etc/default/locale r,
  /etc/default/ufw r,
  /etc/environment r,
  /etc/iproute2/rt_protos r,
  /etc/iproute2/rt_protos.d/ r,
  /etc/login.defs r,
  /etc/pam.d/other r,
  /etc/pam.d/common-auth r,
  /etc/pam.d/common-account r,
  /etc/pam.d/sudo r,
  /etc/pam.d/common-session-noninteractive r,
  /etc/pam.d/common-password r,
  /etc/pam.d/common-session r,
  /etc/security/capability.conf r,
  /etc/security/pam_env.conf r,
  /etc/security/limits.conf r,
  /etc/security/limits.d/ r,
  /etc/shadow r,
  /etc/sudo.conf r,
  /etc/sudoers r,
  /etc/sudoers.d/ r,
  /etc/sudoers.d/** r,
  /etc/ufw/** r,
  /opt/edge-node/bin/** r,
  /proc/** r,
  /proc/ r,
  /run/platform-observability-agent/agent-logs.sock rw,
  /run/ufw.lock wk,
  /sys/devices/system/node/ r,
  /sys/kernel/mm/transparent_hugepage/hpage_pmd_size r,
  /sys/kernel/mm/transparent_hugepage/enabled r,
  /sys/kernel/security/apparmor/profiles r,
  /sys/module/apparmor/parameters/enabled r,
  /usr/bin/awk ix,
  /usr/bin/cat ix,
  /usr/bin/dash ix,
  /usr/bin/gawk ix,
  /usr/bin/grep ix,
  /usr/bin/groups ix,
  /usr/bin/hostnamectl ix,
  /usr/bin/ip ix,
  /usr/bin/jq ix,
  /usr/bin/mawk ix,
  /usr/bin/ps ix,
  /usr/bin/sudo ix,
  /usr/bin/systemctl ix,
  /usr/bin/yq ix,
  /usr/libexec/sudo/libsudo_util.so.0.0.0 rm,
  /usr/libexec/sudo/sudoers.so rm,
  /usr/libexec/sudo/sudoers.so rm,
  /usr/local/bin/yq ix,
  /usr/local/bin/yq_linux_amd64 ix,
  /usr/local/lib/** r,
  /usr/sbin/ r,
  /usr/sbin/aa-status ix,
  /usr/sbin/sysctl ix,
  /usr/sbin/ufw rix,
  /usr/sbin/xtables-nft-multi ix,
  /var/log/kern.log r,
  /var/log/syslog r,
  /var/log/ufw.log r,
  owner /var/log/edge-node/poa/ r,
  owner /var/log/edge-node/poa/* r,
  owner /var/log/edge-node/poa/** rw,

}
