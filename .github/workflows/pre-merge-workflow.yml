---
# SPDX-FileCopyrightText: (C) 2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0
name: Pre-Merge CI Pipeline
on:
  workflow_call:
    inputs:
      runner_version:
        description: "Runner version to use"
        required: true
        default: "ubuntu-24.04"
        type: string
      run_security_scans:
        description: "Run security scans"
        required: false
        default: true
        type: boolean
      run_version_check:
        description: "Run version check"
        required: false
        default: true
        type: boolean
      run_reuse_check:
        description: "Header license scan with reuse"
        required: false
        default: true
        type: boolean
      run_build:
        description: "Run build"
        required: true
        default: true
        type: boolean
      run_lint:
        description: "Run lint"
        required: false
        default: true
        type: boolean
      run_test:
        description: "Run test"
        required: false
        default: true
        type: boolean
      run_integration_test:
        description: "Run integration test"
        required: false
        default: true
        type: boolean
      run_fuzz_test:
        description: "Run fuzz test"
        required: false
        default: true
        type: boolean
      run_package_build:
        description: "Build agent package"
        required: true
        default: true
        type: boolean
      run_package_test:
        description: "Run package test"
        required: false
        default: true
        type: boolean
      run_shellcheck_common:
        description: "Run shellcheck on common scripts"
        required: false
        default: true
        type: boolean
      run_shellcheck_agent:
        description: "Run shellcheck on agent scripts"
        required: false
        default: true
        type: boolean
      prefix_tag_separator:
        description: "If provided, the tag will be prefixed input.project_folder with this separator"
        required: false
        default: ""
        type: string
      project_folder:
        description: "Project subfolder where the job will run, defaults to ."
        required: false
        default: "."
        type: string
      cache_go:
        description: >-
          "Should Go-related cache for project be saved/restored."
        required: false
        default: false
        type: boolean
      remove_cache_go:
        description: >-
          "Should Go-related cache for project be removed when not needed anymore."
        required: false
        default: false
        type: boolean
jobs:
  run-repo-pipelines:
    runs-on: ${{ inputs.runner_version }}
    env:
      GIT_SHORT_URL: ${{ github.repository }}
      PROJECT_NAME: ${{ github.repository }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history, WO sporadic issue with missing tags
          fetch-tags: true # Fetch tags
          ref: ${{ github.head_ref }} # Checkout the branch that triggered the workflow to avoid detached HEAD

      - name: REUSE Compliance Check
        if: ${{ inputs.run_reuse_check == true }}
        uses: fsfe/reuse-action@v4

      - name: Checkout action repository
        uses: actions/checkout@v4
        with:
          repository: open-edge-platform/orch-ci
          path: ci
          ref: cgoea-patch-1
          token: ${{ secrets.SYS_ORCH_GITHUB }}

      - name: Sanitize project folder
        run: |
          SANITIZED_REPORT_PATH=$(echo "${{ inputs.project_folder }}" | tr '/' '-')
          echo "SANITIZED_REPORT_PATH=${SANITIZED_REPORT_PATH}" >> $GITHUB_ENV

      - name: Run ClamAV Scan
        if: ${{ inputs.run_security_scans }}
        uses: open-edge-platform/orch-ci/.github/actions/clamav@40d61a820157bc9b70d3f2bdc5aec786073d48f2
        with:
          report-path: clamav_scan_report-${{ inputs.project_folder }}.txt
          project-folder: ${{ inputs.project_folder }}

      - name: Upload ClamAV Scan Report
        if: ${{ inputs.run_security_scans }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.CLAMAV_ARTIFACT_NAME }}
          path: ${{ env.SANITIZED_CLAMAV_REPORT_PATH }}

      - name: Run Trivy Filesystem Scan
        if: ${{ inputs.run_security_scans }}
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: ${{ inputs.project_folder }}
          format: 'table'
          severity: 'UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL'
          ignore-unfixed: true
          scanners: 'vuln,misconfig,secret'
          output: "trivy_scan_report-${{ env.SANITIZED_REPORT_PATH }}.txt"

      - name: Upload Trivy Scan Report
        if: ${{ inputs.run_security_scans }}
        uses: actions/upload-artifact@v4
        with:
          name: trivy-scan-report-${{ env.SANITIZED_REPORT_PATH }}
          path: trivy_scan_report-${{ env.SANITIZED_REPORT_PATH }}.txt

      - name: Make sure directories where the cache will be restored exist and are empty
        if: ${{ inputs.cache_go }}
        run: |
          # Some caches from previous steps/jobs might be left, clean them up to avoid
          # "Cannot open: File exists" errors

          GOCACHE="$(go env GOCACHE)"
          GOMODCACHE="$(go env GOMODCACHE)"

          mkdir -p "${GOCACHE}" "${GOMODCACHE}" ~/.cache/golangci-lint

          echo "Cache sizes before removal:"
          sudo du -sh "${GOCACHE}"
          sudo du -sh "${GOMODCACHE}"
          sudo du -sh ~/.cache/golangci-lint

          sudo rm -rf "${GOCACHE:?}"/{*,.*} || true
          sudo rm -rf "${GOMODCACHE:?}"/{*,.*} || true
          sudo rm -rf ~/.cache/golangci-lint/{*,.*} || true

          echo "Cache sizes after removal:"
          sudo du -sh "${GOCACHE}"
          sudo du -sh "${GOMODCACHE}"
          sudo du -sh ~/.cache/golangci-lint

          echo "GOCACHE=$GOCACHE" >> "$GITHUB_ENV"
          echo "GOMODCACHE=$GOMODCACHE" >> "$GITHUB_ENV"
  

      - name: Setup CI environment
        uses: ./ci/.github/actions/bootstrap
        with:
          gh_token: ${{ secrets.SYS_ORCH_GITHUB }}

      - name: Restore Go cache
        if: ${{ inputs.cache_go }}
        id: restored-project-go-cache
        uses: actions/cache/restore@5a3ec84eff668545956fd18022155c47e93e2684  # v4.2.4
        with:
          path: |
            ${{ env.GOCACHE }}
            ${{ env.GOMODCACHE }}
            ~/.cache/golangci-lint
          key: ${{ env.REPO_PROJECT }}-${{ runner.os }}-go-${{ env.GOLANG_VER }}-${{ hashFiles('**/go.mod') }}
          restore-keys: |
            ${{ env.REPO_PROJECT }}-${{ runner.os }}-go-${{ env.GOLANG_VER }}-
            ${{ env.REPO_PROJECT }}-${{ runner.os }}-go-
      
      - name: Version Check
        if: ${{ inputs.run_version_check == true }}
        env:
          BASEDIR: ${{ inputs.project_folder }}
        run: |
          if [ -n "${{ inputs.prefix_tag_separator }}" ]; then
            ./ci/scripts/version-check.sh "${{ inputs.project_folder }}${{ inputs.prefix_tag_separator }}"
          else
            ./ci/scripts/version-check.sh
          fi

      - name: Build Code
        if: ${{ inputs.run_build == true }}
        working-directory: ${{ inputs.project_folder }}
        shell: bash
        run: |
          make build

      - name: Lint Code
        if: ${{ inputs.run_lint == true }}
        working-directory: ${{ inputs.project_folder }}
        run: |
          make lint

      - name: Test Code
        if: ${{ inputs.run_test == true }}
        working-directory: ${{ inputs.project_folder }}
        run: |
          make test

      - name: Save Go cache
        if: ${{ inputs.cache_go }}
        uses: actions/cache/save@5a3ec84eff668545956fd18022155c47e93e2684  # v4.2.4
        with:
          path: |
            ${{ env.GOCACHE }}
            ${{ env.GOMODCACHE }}
            ~/.cache/golangci-lint
          key: ${{ steps.restored-project-go-cache.outputs.cache-primary-key }}

      - name: Remove Go-related cache when not needed anymore to free up space
        if: ${{ inputs.remove_cache_go }}
        run: |
          GOCACHE="$(go env GOCACHE)"
          GOMODCACHE="$(go env GOMODCACHE)"

          echo "Cache sizes before removal:"
          sudo du -sh "${GOCACHE}"
          sudo du -sh "${GOMODCACHE}"
          sudo du -sh ~/.cache/golangci-lint

          sudo rm -rf "${GOCACHE:?}"/{*,.*} || true
          sudo rm -rf "${GOMODCACHE:?}"/{*,.*} || true
          sudo rm -rf ~/.cache/golangci-lint/{*,.*} || true

          echo "Cache sizes after removal:"
          sudo du -sh "${GOCACHE}"
          sudo du -sh "${GOMODCACHE}"
          sudo du -sh ~/.cache/golangci-lint

      - name: Integration test
        if: ${{ inputs.run_integration_test == true }}
        working-directory: ${{ inputs.project_folder }}
        shell: bash
        run: |
          make integration_test

      - name: Fuzz test
        if: ${{ inputs.run_integration_test == true }}
        working-directory: ${{ inputs.project_folder }}
        shell: bash
        run: |
          make fuzztest

      - name: Build Package
        if: ${{ inputs.run_package_build == true }}
        working-directory: ${{ inputs.project_folder }}
        shell: bash
        run: |
          make package

      - name: Package test
        if: ${{ inputs.run_package_test == true}}
        working-directory: ${{ inputs.project_folder }}
        shell: bash
        run: |
          #sudo apt update
          #make package_test
          echo "Test package"

      - name: Shellcheck scripts
        if: ${{ inputs.run_shellcheck_common == true }}
        working-directory: ${{ inputs.project_folder }}
        shell: bash
        run: |
          if [ "${{ inputs.project_folder }}" == "common" ]; then
              find . -type f -name *.sh -exec "shellcheck" "-e" "SC2010,SC2086" {} +
          elif [ "${{ inputs.project_folder }}" == "platform-observability-agent" ]; then
              find scripts/ -type f -name *.sh -exec "shellcheck" {} +
          fi

      - name: Send failure email
        if: ${{ failure() }}
        run: |
          echo "Sending failure email..."
