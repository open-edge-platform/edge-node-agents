#!/bin/bash -e

# Update onboarding service URL (OBM_SVC)
if [ ! -z "$ONBOARDING_SVC_URL" ]; then
    sed -i "s|^OBM_SVC=.*|OBM_SVC=$ONBOARDING_SVC_URL|" /etc/edge-node/node/confs/device-discovery-agent.env
fi

# Update onboarding service port (OBM_PORT)
if [ ! -z "$ONBOARDING_SVC_PORT" ]; then
    sed -i "s|^OBM_PORT=.*|OBM_PORT=$ONBOARDING_SVC_PORT|" /etc/edge-node/node/confs/device-discovery-agent.env
fi

# Update onboarding stream service URL (OBS_SVC)
if [ ! -z "$ONBOARDING_STREAM_SVC_URL" ]; then
    sed -i "s|^OBS_SVC=.*|OBS_SVC=$ONBOARDING_STREAM_SVC_URL|" /etc/edge-node/node/confs/device-discovery-agent.env
fi

# Update keycloak URL (KEYCLOAK_URL)
if [ ! -z "$KEYCLOAK_URL" ]; then
    sed -i "s|^KEYCLOAK_URL=.*|KEYCLOAK_URL=$KEYCLOAK_URL|" /etc/edge-node/node/confs/device-discovery-agent.env
fi

# Update CA certificate path (CA_CERT)
if [ ! -z "$CA_PEM" ]; then
    sed -i "s|^CA_CERT=.*|CA_CERT=$CA_PEM|" /etc/edge-node/node/confs/device-discovery-agent.env
fi

# Update auto-detect setting (AUTO_DETECT)
if [ ! -z "$AUTO_DETECT" ]; then
    sed -i "s|^AUTO_DETECT=.*|AUTO_DETECT=$AUTO_DETECT|" /etc/edge-node/node/confs/device-discovery-agent.env
fi

# Update debug mode (DEBUG)
if [ ! -z "$DEBUG" ]; then
    sed -i "s|^DEBUG=.*|DEBUG=$DEBUG|" /etc/edge-node/node/confs/device-discovery-agent.env
fi

# Update disable interactive mode (DISABLE_INTERACTIVE)
if [ ! -z "$DISABLE_INTERACTIVE" ]; then
    sed -i "s|^DISABLE_INTERACTIVE=.*|DISABLE_INTERACTIVE=$DISABLE_INTERACTIVE|" /etc/edge-node/node/confs/device-discovery-agent.env
fi

# Update use kernel args (USE_KERNEL_ARGS)
if [ ! -z "$KERNEL_ARGS" ]; then
    sed -i "s|^USE_KERNEL_ARGS=.*|USE_KERNEL_ARGS=$KERNEL_ARGS|" /etc/edge-node/node/confs/device-discovery-agent.env
fi

# Read hardware serial number and update config
if [ -r /sys/class/dmi/id/product_serial ]; then
    PRODUCT_SERIAL="$(cat /sys/class/dmi/id/product_serial 2>/dev/null | tr -d '\n')"
    if [ ! -z "$PRODUCT_SERIAL" ] && [ "$PRODUCT_SERIAL" != "None" ]; then
        if grep -q "^SERIAL=" /etc/edge-node/node/confs/device-discovery-agent.env; then
            sed -i "s|^SERIAL=.*|SERIAL=$PRODUCT_SERIAL|" /etc/edge-node/node/confs/device-discovery-agent.env
        else
            echo "SERIAL=$PRODUCT_SERIAL" >> /etc/edge-node/node/confs/device-discovery-agent.env
        fi
    fi
elif [ -r /sys/class/dmi/id/board_serial ]; then
    PRODUCT_SERIAL="$(cat /sys/class/dmi/id/board_serial 2>/dev/null | tr -d '\n')"
    if [ ! -z "$PRODUCT_SERIAL" ] && [ "$PRODUCT_SERIAL" != "None" ]; then
        if grep -q "^SERIAL=" /etc/edge-node/node/confs/device-discovery-agent.env; then
            sed -i "s|^SERIAL=.*|SERIAL=$PRODUCT_SERIAL|" /etc/edge-node/node/confs/device-discovery-agent.env
        else
            echo "SERIAL=$PRODUCT_SERIAL" >> /etc/edge-node/node/confs/device-discovery-agent.env
        fi
    fi
fi

# Read hardware UUID and update config
if [ -r /sys/class/dmi/id/product_uuid ]; then
    PRODUCT_UUID="$(cat /sys/class/dmi/id/product_uuid 2>/dev/null | tr -d '\n')"
    if [ ! -z "$PRODUCT_UUID" ] && [ "$PRODUCT_UUID" != "None" ]; then
        if grep -q "^UUID=" /etc/edge-node/node/confs/device-discovery-agent.env; then
            sed -i "s|^UUID=.*|UUID=$PRODUCT_UUID|" /etc/edge-node/node/confs/device-discovery-agent.env
        else
            echo "UUID=$PRODUCT_UUID" >> /etc/edge-node/node/confs/device-discovery-agent.env
        fi
    fi
fi

# Create system group
groupadd -f bm-agents --system

# Create system user
id -u device-discovery-agent &>/dev/null || useradd device-discovery-agent --system -g bm-agents -s /sbin/nologin

# Set permissions for client credentials directory
chmod 700 /etc/intel_edge_node/client-credentials
if [ -d "/etc/intel_edge_node/client-credentials" ]; then
    chmod 600 /etc/intel_edge_node/client-credentials/* 2>/dev/null || true
fi

# Update file/dir ownership
chown device-discovery-agent:bm-agents /etc/intel_edge_node
chown -R device-discovery-agent:bm-agents /etc/intel_edge_node/client-credentials

# Set ownership for edge-node config directory
if [ -d "/etc/edge-node/node/confs" ]; then
    chown -R device-discovery-agent:bm-agents /etc/edge-node/node/confs
    chmod 755 /etc/edge-node/node/confs
fi

# Load AppArmor profile
apparmor_parser -rK /etc/apparmor.d/opt.edge-node.bin.device-discovery-agent

#DEBHELPER#
